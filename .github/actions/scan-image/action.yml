name: Trivy scan image
description: Scan the specified image with trivy and save the results
inputs:
  image-name:  # id of input
    description: Name of the image 
    required: true
  make-command:
    description: 'which make command to run'
    required: true
  upload-data:
    description: Decide if we want to call a webhook
    default: 'false'

runs:
  using: "composite"
  steps:

    - name: build base
      shell: bash
      run: |
        make ${{ inputs.make-command }}
        docker save -o image.tar ${{ inputs.image-name }}

    - if: ${{ inputs.upload-data == 'false' }}
      name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        format: 'table'
        ignore-unfixed: true
        input: image.tar
        scan-type: image
        security-checks: vuln

    - if: ${{ inputs.upload-data == 'true' }}
      name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        format: 'json'
        ignore-unfixed: true
        input: image.tar
        scan-type: image
        security-checks: vuln
        output:  ${{ inputs.image-name}}.json
        severity: 'CRITICAL,HIGH'

    - if: ${{ inputs.upload-data == 'true' }}
      name: Call webhook with json
      shell: bash
      run: |
        echo "Results:\n"
        cat ${{ inputs.friendly-name}}.json
        curl -X POST https://hooks.zapier.com/hooks/catch/14226593/3xgk2p7/?name=${{ inputs.image-name}} -d @${{ inputs.image-name}}.json